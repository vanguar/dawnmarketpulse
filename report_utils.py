import os
# from fpdf import FPDF # –£–±—Ä–∞–ª–∏, —Ç–∞–∫ –∫–∞–∫ PDF –Ω–µ –Ω—É–∂–µ–Ω
from textblob import TextBlob
from datetime import datetime # –î–æ–±–∞–≤–∏–ª–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏, –µ—Å–ª–∏ –±—É–¥–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞—Ç—É

# –ï—Å–ª–∏ generate_pdf –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ–µ –º–æ–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å.
# def generate_pdf(text, output_dir="reports"):
#     # ... (–∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏)

def get_sentiment_description(polarity, subjectivity):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—è—Ä–Ω–æ—Å—Ç–∏ –∏ —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏."""
    
    pol_desc = "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è" # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if polarity > 0.5:
        pol_desc = "–æ—á–µ–Ω—å –ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è"
    elif polarity > 0.15: # –ù–µ–º–Ω–æ–≥–æ –ø–æ–¥–Ω—è–ª –ø–æ—Ä–æ–≥ –¥–ª—è "–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è"
        pol_desc = "—É–º–µ—Ä–µ–Ω–Ω–æ –ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è"
    elif polarity < -0.5:
        pol_desc = "–æ—á–µ–Ω—å –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è"
    elif polarity < -0.15: # –ù–µ–º–Ω–æ–≥–æ –ø–æ–¥–Ω—è–ª –ø–æ—Ä–æ–≥ –¥–ª—è "–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è"
        pol_desc = "—É–º–µ—Ä–µ–Ω–Ω–æ –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è"

    sub_desc = "–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π (—Ñ–æ–∫—É—Å –Ω–∞ —Ñ–∞–∫—Ç–∞—Ö)" # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if subjectivity > 0.75: # –£–≤–µ–ª–∏—á–∏–ª –ø–æ—Ä–æ–≥ –¥–ª—è "–æ—á–µ–Ω—å —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π"
        sub_desc = "–æ—á–µ–Ω—å —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π (–º–Ω–æ–≥–æ –ª–∏—á–Ω—ã—Ö –º–Ω–µ–Ω–∏–π/—ç–º–æ—Ü–∏–π)"
    elif subjectivity > 0.45: # –£–≤–µ–ª–∏—á–∏–ª –ø–æ—Ä–æ–≥ –¥–ª—è "—É–º–µ—Ä–µ–Ω–Ω–æ —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π"
        sub_desc = "—É–º–µ—Ä–µ–Ω–Ω–æ —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π (–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –ª–∏—á–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏)"
            
    return f"–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞: {pol_desc}. –°—Ç–∏–ª—å –∏–∑–ª–æ–∂–µ–Ω–∏—è: {sub_desc}."


def analyze_sentiment(text):
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π."""
    if not isinstance(text, str) or not text.strip():
        return """üß† –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ GPT:
        ‚Ä¢ –û—à–∏–±–∫–∞: –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –∏–ª–∏ –ø—É—Å—Ç."""

    try:
        blob = TextBlob(text)
        polarity = blob.sentiment.polarity
        subjectivity = blob.sentiment.subjectivity

        tone = "üìä –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ" # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if polarity > 0.15:
            tone = "üìà –ü–æ–∑–∏—Ç–∏–≤–Ω–æ–µ"
        elif polarity < -0.15:
            tone = "üìâ –ù–µ–≥–∞—Ç–∏–≤–Ω–æ–µ"
        
        sentiment_details_text = get_sentiment_description(polarity, subjectivity)

        return f"""üß† –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ GPT:
‚Ä¢ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (–æ–±—â–µ–µ): {tone}
‚Ä¢ –ü–æ–ª—è—Ä–Ω–æ—Å—Ç—å (–æ—Ç -1 –¥–æ 1): {polarity:.2f}
‚Ä¢ –°—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–æ—Ç 0 –¥–æ 1): {subjectivity:.2f}
‚Ä¢ –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞: {sentiment_details_text}"""
    except Exception as e:
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∑–¥–µ—Å—å –±—ã–ª–æ –±—ã –ø–æ–ª–µ–∑–Ω–æ, –µ—Å–ª–∏ –±—ã –±—ã–ª–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è log
        # print(f"–û—à–∏–±–∫–∞ –≤ analyze_sentiment: {e}") 
        return """üß† –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ GPT:
        ‚Ä¢ –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏."""