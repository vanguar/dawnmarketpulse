import os
from textblob import TextBlob
from datetime import datetime # –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –¥—Ä—É–≥–∏—Ö —É—Ç–∏–ª–∏—Ç

# –ï—Å–ª–∏ —É –≤–∞—Å –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ –±—ã–ª–∏ –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫—Ä–æ–º–µ —Ç–µ—Ö, —á—Ç–æ —Å–≤—è–∑–∞–Ω—ã —Å –∞–Ω–∞–ª–∏–∑–æ–º —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏,
# –∏ –æ–Ω–∏ –≤–∞–º –Ω—É–∂–Ω—ã, –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –∏—Ö –≤–µ—Ä–Ω—É—Ç—å –∏–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –≤–∞—à–µ–π —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏.
# –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —É –≤–∞—Å –±—ã–ª–∞ —Ñ—É–Ω–∫—Ü–∏—è generate_pdf, –∏ –æ–Ω–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—ë –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å.

def get_sentiment_description_for_report(polarity, subjectivity):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, —Å—Ç–∏–ª—è –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –æ—Ç—á–µ—Ç–∞
    –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª—è—Ä–Ω–æ—Å—Ç–∏ –∏ —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
    """
    
    # –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—è—Ä–Ω–æ—Å—Ç–∏ (—Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏)
    pol_desc_short = "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è" # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if polarity > 0.15:
        pol_desc_short = "–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è"
    elif polarity < -0.15:
        pol_desc_short = "–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è"

    # –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∏–ª—è –∏–∑–ª–æ–∂–µ–Ω–∏—è (—Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
    sub_style_desc = "–æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å" # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    comment_text = "–¢–µ–∫—Å—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ —Ñ–∞–∫—Ç–∞—Ö –∏ –¥–∞–Ω–Ω—ã—Ö, –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —è—Ä–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ –∏–ª–∏ –ª–∏—á–Ω—ã—Ö –º–Ω–µ–Ω–∏–π." # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    if subjectivity > 0.75: # –û—á–µ–Ω—å —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π
        sub_style_desc = "–æ—á–µ–Ω—å —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å"
        comment_text = "–¢–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—á–Ω—ã—Ö –º–Ω–µ–Ω–∏–π, –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π –∏–ª–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π, –æ—Ç—Ö–æ–¥—è –æ—Ç —á–∏—Å—Ç–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–ª–æ–∂–µ–Ω–∏—è."
    elif subjectivity > 0.45: # –£–º–µ—Ä–µ–Ω–Ω–æ —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π
        sub_style_desc = "—É–º–µ—Ä–µ–Ω–Ω–æ —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å"
        comment_text = "–í —Ç–µ–∫—Å—Ç–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –ª–∏—á–Ω–æ–π –æ—Ü–µ–Ω–∫–∏, –º–Ω–µ–Ω–∏–π –∏–ª–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π –Ω–∞—Ä—è–¥—É —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π."
            
    return pol_desc_short, sub_style_desc, comment_text


def analyze_sentiment(text_to_analyze):
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é TextBlob
    –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π,
    –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–ª—è —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ –æ—Ç—á–µ—Ç–µ.
    """
    if not isinstance(text_to_analyze, str) or not text_to_analyze.strip():
        return """üß† –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ GPT:
        ‚Ä¢ –û—à–∏–±–∫–∞: –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –∏–ª–∏ –ø—É—Å—Ç."""

    try:
        # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç TextBlob –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        blob = TextBlob(text_to_analyze)
        
        # –ü–æ–ª—É—á–∞–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—è—Ä–Ω–æ—Å—Ç–∏ –∏ —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        polarity = blob.sentiment.polarity
        subjectivity = blob.sentiment.subjectivity

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –æ—Ç—á–µ—Ç–∞
        # (pol_desc_short –±—É–¥–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è")
        # (sub_style_desc –±—É–¥–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ç–∏–ª—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, "–æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å")
        # (comment_text –±—É–¥–µ—Ç –æ–±—â–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º)
        pol_desc_short, sub_style_desc, comment_text = get_sentiment_description_for_report(polarity, subjectivity)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–º–æ–¥–∑–∏ –¥–ª—è –æ–±—â–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è (—Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏)
        tone_emoji = "üìä" # –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if polarity > 0.15:
            tone_emoji = "üìà" # –ü–æ–∑–∏—Ç–∏–≤–Ω–æ–µ
        elif polarity < -0.15:
            tone_emoji = "üìâ" # –ù–µ–≥–∞—Ç–∏–≤–Ω–æ–µ
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –æ—Ç—á–µ—Ç–∞
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤–æ–π–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –≤ Telegram
        return f"""üß† –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ GPT:

{tone_emoji} –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: {pol_desc_short} (—á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {polarity:.2f})
üßê –°—Ç–∏–ª—å –∏–∑–ª–æ–∂–µ–Ω–∏—è: {sub_style_desc} (—á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {subjectivity:.2f})

üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç GPT-–ê–Ω–∞–ª–∏—Ç–∏–∫–∞: {comment_text}"""

    except Exception as e:
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ 'e' –∑–¥–µ—Å—å, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        # print(f"–û—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ analyze_sentiment: {e}")
        return """üß† –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ GPT:
        ‚Ä¢ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏."""

# –ï—Å–ª–∏ —É –≤–∞—Å –±—ã–ª–∏ –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, generate_pdf, –∫–∞–∫ —É–ø–æ–º–∏–Ω–∞–ª–æ—Å—å —Ä–∞–Ω–µ–µ),
# —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∏ –∑–¥–µ—Å—å –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç, –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å–µ –µ—â–µ –Ω—É–∂–Ω—ã.
# –ï—Å–ª–∏ generate_pdf –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ–µ –º–æ–∂–Ω–æ —Å–º–µ–ª–æ —É–¥–∞–ª–∏—Ç—å.